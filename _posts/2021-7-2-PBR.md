---
layout:     post
title:      "年轻人第一个PBR"
subtitle:   ""
date:       2021-7-2
author:     "Burt"
header-style: text 
tags:
    - Shader
---



## 前言

天天说pbr，那pbr到底是啥



## 一、介绍

Physically Based Rendering：基于物理的渲染

**PBR是一种渲染方式**，使用基于物理原理和微平面理论的**光照模型**，以及使用从现实中测量的表面参数来准确表示真是世界材质的渲染理念

PBR是一系列技术的集合，包括GI、PBS

PBS又包括（这里以Unity_BRDF1为例子）：

- 迪士尼漫反射
- GGX分布模型高光
- IBL



最终颜色 = 漫反射（迪士尼漫反射） + GI漫反射 + 镜面反射（GGX模型和菲涅尔） + IBL（包含GI镜面反射）

即：

最终颜色 = 直接光照 + 间接光照 + 直接反射 + 间接反射



它的好处是：它不仅可以让最终的画面更加真实，同时也更容易设计出让Artists能够更直观的修改和编辑材质属性的系统



**实际上的“PB”在实时渲染并不完全是Physically Based**



PBR材质有两个方面

- 表面：相对容易实现，大部分用于微平面理论和迪士尼BRDF
- 体积：相对更难实现，关注快速、近似的单次散射和多次散射，例如云，皮肤，头发等

在现如今的PBR材质上面基本很少新的理论出现



### 1.PBS

Physically Based Shading：基于物理的着色

PBS是为了对光和材质之间进行更加真实的建模

基于物理渲染的本质就是PBS

PBS分为金属流和高光流，两者达到的效果是一样的，只是个别参数和贴图是有区别的

**PBS核心理论：**

1. 物质的光学特性
   - 现实物质根据导电性分为三类：绝缘体、半导体、金属
   - 渲染领域分为：导体（金属）、绝缘体（非金属）
     - 金属具有很高的反射率（≥ 0.5），会立即吸收任何折射光，因此金属不会出现任何次表面散射和透明效果。金属的所有可见颜色都来自反射
     - 非金属具有很低的反射率（<=0.06），会产生高光反射与漫反射现象。非金属的高光反射为单色/灰色
2. 微平面理论
   - 现实世界的表面大多都不是光学平滑的，这种微观几何上的变化会导致每个表面点对光有不同的反射和折射
   - 所以基于物理渲染的PBS技术都是基于微平面理论的，它假想任何平面都是由微平面组成的，根据这些微平面粗糙程度的不同，采用**粗糙度贴图**或者**高光度贴图**来进行表示
   - 一个平面越是粗糙，这个平面上的微平面排列就越是混乱![](http://5b0988e595225.cdn.sohucs.com/images/20191114/6cb12db119b94aa8a428c62a7c3debf2.jpeg)
3. 能量守恒
   - 出射光线的能量永远不能超过入射光线的能量（自发光除外）
   - 镜面反射 + 漫反射 <= 入射光
   - 随着粗糙度的上升，镜面反射区域的面积会增加，基于能量守恒，故镜面反射区域的亮度则会降低
4. 菲涅尔反射
   - 是一种表示看到光线的反射率与视角相关的现象
   
     ![](http://5b0988e595225.cdn.sohucs.com/images/20191114/055cdc4ca9324a5ab6bf51686eb44e5b.jpeg)
   
   - 即光源入射方向与平面法线方向夹角的对应关系。夹角越大，反射越大，亮度也越大；反之夹角越小，反射就越小，亮度也就越小
   
     ![](http://5b0988e595225.cdn.sohucs.com/images/20191114/5045ffcf2bd04675854cc114d74801d3.jpeg)
5. 线性空间光照
   
   - 为了保证光照渲染的正确性，所以最好是在线性（linear）空间中进行操作与计算，这样才能尽最大的还原现实世界中光与物质的交互
   
     ![](http://docs.manew.com/Manual/img/LinearLighting-1.jpg)





**双向反射分布函数BRDF**

表面散射的性质通常用BRDF（双向反射分布函数）来表示。一句话不严谨的概括BRDF既是输入一个入射的方向和一个出射的方向，输出一个出射光线和入射光线能量的比值

对于一个BRDF，为了实现物理学上的可信度，它必须遵守能量守恒定律，也就是说反射光线的总和永远不能超过入射光线的总量

这是一个渲染方程，描述了光能在场景中的流动，根据光的物理学原理，渲染方程可以完美的模拟出符合物理光学的结果

$L_{o} =L_{e} + \int_{Ω} f_{r} * L_{i} *(w_{i}*n) * dw_{i} $

其中：

- L<sub>o</sub> 是当前点的出射光亮度
- L<sub>e</sub> 是当前点的自发光亮度
- **f<sub>r</sub> 是当前点的入射方向到出射方向光的反射比例，为BxDF**
- L<sub>i</sub> 是当前点的入射光角度
- (w<sub>i</sub> * n) 是入射角带来的入射光衰减
- $\int_{Ω}...dw_{i}$ 是入射方向半球的积分，可以理解为无穷小的累加和

![](https://di.gameres.com/attachment/forum/201912/09/110300yyewei7jwekkgljd.jpg)

1. 普通反射的行为用BRDF描述
2. 次表现散射的行为用BSSRDF描述
3. 透射的行为用BTDF描述

总体来说，BRDF 为 BSSRDF 的一种简化

BSDF可分为反射和透射分量两部分，即BSDF = BRDF + BTDF





**迪斯尼原则的BRDF**

由于其**高度的通用性**在电影节和游戏界引起不小的轰动

受到迪士尼原则的BRDF的启发，Unity和UE也陆续实现了各自的PBR渲染流程

核心理念：

- 使用直观的参数，而不是晦涩的物理类参数
- 参数尽可能的少
- 参数在其合理范围内应该为0-1
- 允许参数在有意义的情况下超出正常的范围
- 所有参数组应尽可能的健壮与合理   

![](http://www.cxybcw.com/wp-content/uploads/2020/02/beepress2-1580990646.jpeg)

1. **BaseColor（固有色，图中没有，这是最基础的属性）：表面的颜色，通常由纹理提供**
2. Subsurface（次表面）：使用次表面近似的控制漫反射形状
3. **Metallie（金属度）：0 = 非金属，1 = 金属，这是两种不同模型之间的线性混合**
4. Specular（镜面反射强度）：镜面反射的强度
5. SpecularTint（镜面反射颜色）：对美术控制的让步，用于对BaseColor的入射镜面反射进行颜色控制
6. **Roughness（粗糙度）：表面粗糙度，控制漫反射和镜面反射**
7. Anisotropic（各向异性强度）：用于控制镜面反射高光的纵横比，0 = 各向同性，1 = 各向异性
8. Sheen（光泽度）：一种额外的掠射分量，主要用于布料
9. SheenTint（光泽颜色）：对Sheen的颜色控制
10. ClearCoat（清漆强度）：特殊用途的第二个镜面波瓣
11. ClearCoatCloss（清漆光泽度）：控制透明涂层光泽度



**其他BRDF模型**

- Blinn-Phong：简单快速，各向同性，表达能力有限。然而由于该模型并没有遵循能量守恒定律(经验模型)，因此它不被认为是基于物理的渲染
- Cook-Torrance：复杂一些，各向同性，可以较好地表达真实材质。现在已经有很好几种BRDF都能近似的得出物体表面对于光的反应，但是几乎所有实时渲染管线使用的都是此模型
- Ward：复杂一些，支持各向异性



## 二、实现

待续





## References：

1. https://zhuanlan.zhihu.com/p/20091064?f3fb8ead20=44d0e4ef145790c113921ea174da514f
2. https://www.bilibili.com/video/BV1YK4y1T7yY?p=10